# docker build \
#   --build-arg USER_ID=$(id -u) \
#   --build-arg GROUP_ID=$(id -g) \
#   --tag xyplatform:lubuntu1804 \
#   --file Dockerfile1804Desktop \
#   ${PWD}
#
# docker run -d --rm=true --privileged \
#   -p 5910:5900 \
#   -p 222:22 \
#   -e RESOLUTION=1920x1200 \
#   -v ~/.ssh:/root/.ssh \
#   -v ~/.m2:/root/.m2:rw \
#   --shm-size 1024M \
#   xyplatform:autobdd

FROM dorowu/ubuntu-desktop-lxde-vnc:latest
USER root
ENV HOME /root
ENV JAVA_VERSION 8
ENV DEBIAN_FRONTEND noninteractive

# apt install essential tools for apt install/upgrade
RUN apt clean -y -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" 
RUN apt update -y -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" 
RUN apt full-upgrade -y -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" 
RUN apt install -q -y --allow-unauthenticated --fix-missing --no-install-recommends -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" \
		apt-utils \
        wget
# Set the timezone.
RUN sudo dpkg-reconfigure -f noninteractive tzdata

# # install standard linux tools needed for automation framework
RUN apt install -q -y --allow-unauthenticated --fix-missing --no-install-recommends -o Dpkg::Options::="--force-confdef" \
 -o Dpkg::Options::="--force-confold" \
    autofs \
    binutils \
    build-essential \
    dirmngr \
    ffmpeg \
    fonts-liberation \
    git \
    gpg-agent \
    imagemagick \
    java-common \
    libappindicator3-1 \
    libatk-bridge2.0-0 \
    libgtk-3-0 \
    libnspr4 \
    libnss3 \
    libopencv-dev \
    libpython2.7-stdlib \
    libpython3-stdlib \
    libxss1 \
    locales \
    lsof \
    lubuntu-core \
    maven \
    net-tools \
    ntpdate \
    openjdk-8-jdk \
    openjdk-8-jre \
    python2.7-dev \
    python2.7-minimal \
    python3-dev \
    python3-minimal \
    python3-pip \
    python-pip \
    rdesktop \
    rsync \
    sqlite3 \
    openssh-server \  
    tdsodbc \
    tesseract-ocr \
    tree \
    unixodbc \
    unixodbc-dev \
    unzip \
    wmctrl \
    x11vnc \
    xclip \
    xdg-utils \
    xdotool \
    xvfb \
    zlib1g-dev

# install tinydb used for autorunner framework
RUN pip install tinydb

# install additional tools (chrome and java) needed for automation framework
RUN update-ca-certificates

# instal google-chrome
RUN rm -f /etc/apt/sources.list.d/google-chrome.list && \
    echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google-chrome.list && \
    wget -qO- --no-check-certificate https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add - && \
    apt update -y -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold"  && \
    apt install -q -y --allow-unauthenticated --fix-missing -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" \
    google-chrome-stable

# install nodejs 
RUN curl -sL https://deb.nodesource.com/setup_8.x | sudo -E bash - && \
    apt update -y -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold"  && \
    apt install -q -y --allow-unauthenticated --fix-missing -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" \
    nodejs

# final autoremove
RUN apt update -y -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" && \
    apt --purge autoremove -y -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold"

# Allow root ssh by key
RUN sed -i "s/^#PermitRootLogin/PermitRootLogin/" /etc/ssh/sshd_config

# run finishing set up
RUN update-alternatives --set java /usr/lib/jvm/java-8-openjdk-amd64/jre/bin/java
RUN ln -s /usr/lib/jni/libopencv_java*.so /usr/lib/libopencv_java.so
RUN /usr/sbin/locale-gen "en_US.UTF-8"; echo LANG="en_US.UTF-8" > /etc/locale.conf
RUN mkdir -p /tmp/.X11-unix && chmod 1777  /tmp/.X11-unix

# create convenient alias for AutoBDD
RUN echo "alias spr='rsync --human-readable --progress --update --archive --exclude .git/ --exclude node_modules/ --exclude xyPlatform/ ${HOME}/Projects/ ${HOME}/Run'" > /root/.bashrc && \
    echo "alias srp='rsync --human-readable --progress --update --archive --exclude node_modules/ --exclude target/ --exclude logs/ $HOME/Run/ ${HOME}/Projects'" >> /root/.bashrc && \
    echo "alias xvfb-auto='xvfb-run --auto-servernum --server-args=\"-screen 0 1920x1200x16\"'" >> /root/.bashrc && \
    chmod +x /root/.bashrc

# download AutoBDD
RUN mkdir -p /root/Projects && cd /root/Projects && \
    wget https://github.com/xwvArmour/AutoBDD/archive/master.zip && \
    unzip master.zip && rm master.zip && \
    mv AutoBDD-master AutoBDD && cd AutoBDD && npm install
